<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .summary-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            height: 100%;
            border-left: 5px solid;
        }
        .total-expenses {
            border-left-color: #3498db;
        }
        .pending-payments {
            border-left-color: #e74c3c;
        }
        .top-category {
            border-left-color: #2ecc71;
        }
        .summary-card h3 {
            margin-top: 0;
            color: #34495e;
            font-size: 1.2em;
        }
        .summary-card p {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0 0;
        }
        .summary-card .subtitle {
            font-size: 0.9em;
            color: #95a5a6;
            margin: 5px 0 0;
        }
        .graph-container {
            margin-bottom: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            height: 100%;
        }
        .btn-update {
            background-color: #3498db;
            color: white;
            border: none;
            transition: all 0.3s;
        }
        .btn-update:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        .btn-update:active {
            transform: translateY(0);
        }
        .update-status {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .update-success {
            background-color: #d4edda;
            color: #155724;
        }
        .update-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading-spinner {
            display: none;
            margin-left: 10px;
        }
        .last-update {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        table {
            width: 100%;
        }
        th {
            background-color: rgb(55, 83, 109);
            color: white;
        }
        tr:nth-child(even) {
            background-color: lavender;
        }
        @media (max-width: 768px) {
            .summary-card {
                margin-bottom: 20px;
            }
            .graph-container {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container my-4">
        <div class="header">
            <h1>Dashboard Financeiro</h1>
            <p>Acompanhamento de despesas, categorias e pagamentos pendentes</p>
            <div class="d-flex justify-content-center align-items-center">
                <button id="updateButton" class="btn btn-update">
                    <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                    <span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                </button>
                <div class="ms-3 last-update">
                    Última atualização: <span id="lastUpdateTime">Nunca</span>
                </div>
            </div>
            <div id="updateStatus" class="update-status"></div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="summary-card total-expenses">
                    <h3>Total de Despesas</h3>
                    <p id="totalExpenses">R$ 0,00</p>
                    <div class="subtitle">Valor total de todas as despesas</div>
                </div>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="summary-card pending-payments">
                    <h3>Pagamentos Pendentes</h3>
                    <p id="pendingCount">0</p>
                    <div class="subtitle">Número de pagamentos não realizados</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-card top-category">
                    <h3>Categoria Principal</h3>
                    <p id="topCategory">-</p>
                    <div class="subtitle" id="topCategoryValue">R$ 0,00</div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="graph-container">
                    <h3>Despesas Mensais</h3>
                    <div id="monthlyExpensesChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="graph-container">
                    <h3>Gastos por Categoria</h3>
                    <div id="categoryExpensesChart" style="height: 500px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="graph-container">
                    <h3>Pagamentos Pendentes</h3>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Fornecedor</th>
                                    <th>Vencimento</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPaymentsTable">
                                <tr>
                                    <td colspan="5" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // Configuração da API do Google Sheets
        const SHEET_ID = '1TOAFgcacj6FbZk_sD5O6engaw1Y6UPyR7m59UCjm8Z4';
        const SHEET_NAME = 'Sheet1';
        const API_KEY = 'AIzaSyBPMxF9GbSCXZw9CJnQZcbCh8mR3v9Xwjw'; // Esta é uma chave de exemplo, você precisará criar sua própria
        
        // Função para limpar valores monetários
        function cleanCurrency(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace('R$', '').replace('.', '').replace(',', '.').trim() || 0);
            }
            return parseFloat(value || 0);
        }
        
        // Função para formatar valores monetários
        function formatCurrency(value) {
            return 'R$ ' + value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        // Função para formatar datas
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            
            // Assumindo formato DD/MM/YY ou DD/MM/YYYY
            const day = parts[0];
            const month = parts[1];
            const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
            
            return `${day}/${month}/${year}`;
        }
        
        // Função para atualizar o dashboard
        function updateDashboard() {
            // Mostrar spinner de carregamento
            $('.loading-spinner').show();
            $('#updateButton').prop('disabled', true);
            $('#updateStatus').removeClass('update-success update-error').hide();
            
            // URL da API do Google Sheets
            const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
            
            // Fazer requisição para a API
            $.ajax({
                url: sheetUrl,
                type: 'GET',
                success: function(response) {
                    try {
                        // Processar dados
                        const data = processSheetData(response.values);
                        
                        // Atualizar visualizações
                        updateSummaryCards(data);
                        updateMonthlyExpensesChart(data);
                        updateCategoryExpensesChart(data);
                        updatePendingPaymentsTable(data);
                        
                        // Atualizar timestamp
                        const now = new Date();
                        $('#lastUpdateTime').text(now.toLocaleString());
                        
                        // Mostrar mensagem de sucesso
                        $('#updateStatus')
                            .text('Dados atualizados com sucesso!')
                            .addClass('update-success')
                            .show();
                    } catch (error) {
                        console.error('Erro ao processar dados:', error);
                        $('#updateStatus')
                            .text('Erro ao processar dados: ' + error.message)
                            .addClass('update-error')
                            .show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro na requisição:', error);
                    $('#updateStatus')
                        .text('Erro ao buscar dados: ' + error)
                        .addClass('update-error')
                        .show();
                },
                complete: function() {
                    // Esconder spinner de carregamento
                    $('.loading-spinner').hide();
                    $('#updateButton').prop('disabled', false);
                }
            });
        }
        
        // Função para processar dados da planilha
        function processSheetData(values) {
            if (!values || values.length < 2) {
                throw new Error('Dados insuficientes na planilha');
            }
            
            // Obter cabeçalhos
            const headers = values[0];
            
            // Mapear índices de colunas importantes
            const colIndices = {
                descricao: headers.indexOf('Descrição'),
                valorPagamento: headers.indexOf('Valor Pagamento'),
                categoria: headers.indexOf('Categoria'),
                fornecedor: headers.indexOf('Fornecedor'),
                vencimento: headers.indexOf('Vencimento'),
                statusPagamento: headers.indexOf('status do pagamento'),
                mesVencimento: headers.indexOf('Mes de Vencimento')
            };
            
            // Verificar se todas as colunas necessárias foram encontradas
            for (const [key, index] of Object.entries(colIndices)) {
                if (index === -1) {
                    throw new Error(`Coluna '${key}' não encontrada na planilha`);
                }
            }
            
            // Processar linhas de dados
            const rows = values.slice(1).map(row => {
                // Garantir que a linha tem elementos suficientes
                if (row.length <= Math.max(...Object.values(colIndices))) {
                    const newRow = [...row];
                    while (newRow.length <= Math.max(...Object.values(colIndices))) {
                        newRow.push('');
                    }
                    row = newRow;
                }
                
                return {
                    descricao: row[colIndices.descricao] || '',
                    valorPagamento: cleanCurrency(row[colIndices.valorPagamento]),
                    categoria: row[colIndices.categoria] || '',
                    fornecedor: row[colIndices.fornecedor] || '',
                    vencimento: row[colIndices.vencimento] || '',
                    statusPagamento: row[colIndices.statusPagamento] || '',
                    mesVencimento: row[colIndices.mesVencimento] || ''
                };
            });
            
            return {
                rows: rows,
                totalExpenses: rows.reduce((sum, row) => sum + row.valorPagamento, 0),
                pendingPayments: rows.filter(row => row.statusPagamento !== 'Pago'),
                monthlyExpenses: calculateMonthlyExpenses(rows),
                categoryExpenses: calculateCategoryExpenses(rows)
            };
        }
        
        // Função para calcular despesas mensais
        function calculateMonthlyExpenses(rows) {
            const monthlyData = {};
            
            rows.forEach(row => {
                if (row.mesVencimento) {
                    if (!monthlyData[row.mesVencimento]) {
                        monthlyData[row.mesVencimento] = 0;
                    }
                    monthlyData[row.mesVencimento] += row.valorPagamento;
                }
            });
            
            // Converter para array e ordenar por mês
            return Object.entries(monthlyData)
                .map(([month, value]) => ({ month, value }))
                .sort((a, b) => {
                    const [monthA, yearA] = a.month.split('/');
                    const [monthB, yearB] = b.month.split('/');
                    
                    if (yearA !== yearB) return yearA - yearB;
                    return monthA - monthB;
                });
        }
        
        // Função para calcular despesas por categoria
        function calculateCategoryExpenses(rows) {
            const categoryData = {};
            
            rows.forEach(row => {
                if (row.categoria) {
                    if (!categoryData[row.categoria]) {
                        categoryData[row.categoria] = 0;
                    }
                    categoryData[row.categoria] += row.valorPagamento;
                }
            });
            
            // Converter para array e ordenar por valor
            return Object.entries(categoryData)
                .map(([category, value]) => ({ category, value }))
                .sort((a, b) => b.value - a.value);
        }
        
        // Função para atualizar os cards de resumo
        function updateSummaryCards(data) {
            $('#totalExpenses').text(formatCurrency(data.totalExpenses));
            $('#pendingCount').text(data.pendingPayments.length);
            
            if (data.categoryExpenses.length > 0) {
                const topCategory = data.categoryExpenses[0];
                $('#topCategory').text(topCategory.category);
                $('#topCategoryValue').text(formatCurrency(topCategory.value));
            } else {
                $('#topCategory').text('-');
                $('#topCategoryValue').text('R$ 0,00');
            }
        }
        
        // Função para atualizar o gráfico de despesas mensais
        function updateMonthlyExpensesChart(data) {
            const monthlyData = data.monthlyExpenses;
            
            const trace = {
                x: monthlyData.map(item => item.month),
                y: monthlyData.map(item => item.value),
                text: monthlyData.map(item => formatCurrency(item.value)),
                type: 'bar',
                marker: {
                    color: 'rgb(55, 83, 109)'
                },
                textposition: 'auto'
            };
            
            const layout = {
                margin: { t: 10, b: 80, l: 80, r: 40 },
                xaxis: {
                    title: 'Mês'
                },
                yaxis: {
                    title: 'Valor (R$)'
                },
                template: 'plotly_white',
                responsive: true
            };
            
            Plotly.newPlot('monthlyExpensesChart', [trace], layout, {responsive: true});
        }
        
        // Função para atualizar o gráfico de gastos por categoria
        function updateCategoryExpensesChart(data) {
            const categoryData = data.categoryExpenses;
            
            const trace = {
                values: categoryData.map(item => item.value),
                labels: categoryData.map(item => item.category),
                type: 'pie',
                hole: 0.4,
                textinfo: 'label+percent',
                insidetextorientation: 'radial'
            };
            
            const layout = {
                margin: { t: 10, b: 10, l: 10, r: 10 },
                showlegend: false,
                template: 'plotly_white',
                responsive: true
            };
            
            Plotly.newPlot('categoryExpensesChart', [trace], layout, {responsive: true});
        }
        
        // Função para atualizar a tabela de pagamentos pendentes
        function updatePendingPaymentsTable(data) {
            const pendingPayments = data.pendingPayments.slice(0, 10); // Limitar a 10 itens
            
            let tableHtml = '';
            
            if (pendingPayments.length === 0) {
                tableHtml = '<tr><td colspan="5" class="text-center">Nenhum pagamento pendente encontrado</td></tr>';
            } else {
                pendingPayments.forEach(payment => {
                    tableHtml += `
                        <tr>
                            <td>${payment.descricao || '-'}</td>
                            <td>${payment.fornecedor || '-'}</td>
                            <td>${formatDate(payment.vencimento) || '-'}</td>
                            <td>${formatCurrency(payment.valorPagamento)}</td>
                            <td>${payment.statusPagamento || '-'}</td>
                        </tr>
                    `;
                });
            }
            
            $('#pendingPaymentsTable').html(tableHtml);
        }
        
        // Inicializar dashboard quando a página carregar
        $(document).ready(function() {
            // Configurar evento de clique no botão de atualização
            $('#updateButton').on('click', function() {
                updateDashboard();
            });
            
            // Carregar dados iniciais
            updateDashboard();
        });
    </script>
</body>
</html>
