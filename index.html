<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Financeiro</title>

  <!-- Bootstrap CSS v5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Font Awesome para ícones -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <!-- DateRangePicker CSS (para seleção de período) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
  />

  <!-- Estilos customizados -->
  <style>
    :root {
      --primary-blue: #1a3a5f;
      --success-green: #28a745;
      --warning-yellow: #ffc107;
      --danger-red: #dc3545;
      --info-teal: #17a2b8;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    /* Sidebar */
    #sidebar {
      width: 250px;
      background-color: #1e2736;
      color: white;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      padding-top: 20px;
    }
    #sidebar .user-info {
      text-align: center;
      margin-bottom: 30px;
    }
    #sidebar .user-info img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
    }
    #sidebar .nav-link {
      color: #cfd8dc;
    }
    #sidebar .nav-link.active {
      background-color: #343a40;
      color: #ffffff;
    }
    /* Conteúdo principal */
    #content {
      margin-left: 250px;
      height: 100vh;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 20px;
    }
    .card-stat {
      border-left: 5px solid;
    }
    .stat-paid {
      border-left-color: var(--success-green);
    }
    .stat-due {
      border-left-color: var(--warning-yellow);
    }
    .stat-overdue {
      border-left-color: var(--danger-red);
    }
    .stat-total {
      border-left-color: var(--primary-blue);
    }
    .filter-badge {
      margin-right: 5px;
    }
    .highlighted {
      background-color: #fff3cd !important;
    }
    /* Tabelas */
    table th {
      background-color: var(--primary-blue);
      color: white;
    }
    table tr:nth-child(even) {
      background-color: lavender;
    }
    /* Botão limpar filtros */
    #btnClearFilters {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav id="sidebar" class="d-flex flex-column">
    <div class="user-info">
      <img src="https://i.pravatar.cc/80" alt="Avatar do Usuário" />
      <h5>Ricardo Itacarambi</h5>
    </div>
    <ul class="nav nav-pills flex-column" id="menuTabs" role="tablist">
      <li class="nav-item">
        <button
          class="nav-link active"
          id="tab-overview"
          data-bs-toggle="tab"
          data-bs-target="#pane-overview"
          type="button"
          role="tab"
        >
          <i class="fas fa-chart-pie me-2"></i>Visão Geral
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          id="tab-reports"
          data-bs-toggle="tab"
          data-bs-target="#pane-reports"
          type="button"
          role="tab"
        >
          <i class="fas fa-file-alt me-2"></i>Relatórios
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          id="tab-settings"
          data-bs-toggle="tab"
          data-bs-target="#pane-settings"
          type="button"
          role="tab"
        >
          <i class="fas fa-cog me-2"></i>Configurações
        </button>
      </li>
    </ul>
  </nav>

  <!-- Conteúdo principal -->
  <div id="content">
    <div class="tab-content">
      <!-- === ABA 1: Visão Geral === -->
      <div
        class="tab-pane fade show active"
        id="pane-overview"
        role="tabpanel"
      >
        <!-- Título e Filtros -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Dashboard Financeiro</h2>
          <div>
            <input
              type="text"
              id="dateRangeFilter"
              class="form-control"
              style="display: inline-block; width: 200px"
              placeholder="Selecione um período"
              readonly
            />
            <button
              id="btnClearFilters"
              class="btn btn-sm btn-outline-secondary ms-2"
            >
              <i class="fas fa-filter-circle-xmark"></i> Limpar Filtros
            </button>
          </div>
        </div>

        <!-- Badges de filtros ativos -->
        <div id="activeFilters" class="mb-3">
          <span class="me-2">Filtros ativos:</span>
          <span id="badgesContainer">Nenhum filtro aplicado</span>
        </div>

        <!-- Cards de estatísticas -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card card-stat stat-paid p-3">
              <h6>Pagos</h6>
              <h4 id="statPaid">R$ 0,00</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stat stat-due p-3">
              <h6>A Vencer</h6>
              <h4 id="statDue">R$ 0,00</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stat stat-overdue p-3">
              <h6>Vencidos</h6>
              <h4 id="statOverdue">R$ 0,00</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stat stat-total p-3">
              <h6>Total Geral</h6>
              <h4 id="statTotal">R$ 0,00</h4>
            </div>
          </div>
        </div>

        <!-- Gráficos Principais -->
        <div class="row g-3 mb-4">
          <!-- Gráfico de Colunas Mensal -->
          <div class="col-lg-6">
            <div class="card p-3">
              <h6>Despesas Mensais</h6>
              <div id="chartMonthly" style="height: 300px"></div>
            </div>
          </div>
          <!-- Gráfico de Pizza -->
          <div class="col-lg-6">
            <div class="card p-3">
              <h6>Proporção de Status</h6>
              <div id="chartStatus" style="height: 300px"></div>
            </div>
          </div>
        </div>

        <!-- Listas de Pagamentos -->
        <div class="row g-3">
          <!-- Vencidos -->
          <div class="col-lg-4">
            <div class="card p-3">
              <h6>Pagamentos Vencidos</h6>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Descrição</th>
                      <th>Vencimento</th>
                      <th>Valor</th>
                    </tr>
                  </thead>
                  <tbody id="tableOverdue">
                    <tr><td colspan="3" class="text-center">Carregando…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- A Vencer -->
          <div class="col-lg-4">
            <div class="card p-3">
              <h6>Pagamentos a Vencer</h6>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Descrição</th>
                      <th>Vencimento</th>
                      <th>Valor</th>
                    </tr>
                  </thead>
                  <tbody id="tableDue">
                    <tr><td colspan="3" class="text-center">Carregando…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Pagos -->
          <div class="col-lg-4">
            <div class="card p-3">
              <h6>Pagamentos Pagos</h6>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Descrição</th>
                      <th>Data de Pagamento</th>
                      <th>Valor</th>
                    </tr>
                  </thead>
                  <tbody id="tablePaid">
                    <tr><td colspan="3" class="text-center">Carregando…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- === ABA 2: Relatórios (placeholder) === -->
      <div class="tab-pane fade" id="pane-reports" role="tabpanel">
        <div class="p-4">
          <h3>Relatórios</h3>
          <p>Seção de relatórios em desenvolvimento…</p>
        </div>
      </div>

      <!-- === ABA 3: Configurações (placeholder) === -->
      <div class="tab-pane fade" id="pane-settings" role="tabpanel">
        <div class="p-4">
          <h3>Configurações</h3>
          <p>Aqui você pode alterar colunas, cores ou comportamento futuro.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts externos -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Carrega o config.js (já apontando para SheetDB) -->
  <script src="config.js"></script>

  <!-- JavaScript principal -->
  <script>
    $(function () {
      // Variável global do endpoint do SheetDB
      const SHEETDB_URL = window.config.sheetDB.apiUrl;

      // Guarda todos os dados brutos recebidos
      let allRows = [];

      // Guarda filtros ativos
      const filters = {
        dateFrom: null,
        dateTo: null,
        status: null,
        categoria: null,
        servico: null
      };

      /** FUNÇÕES AUXILIARES **/
      function cleanCurrency(val) {
        if (typeof val === 'string') {
          return parseFloat(
            val.replace('R$', '').replace('.', '').replace(',', '.').trim() || 0
          );
        }
        return parseFloat(val || 0);
      }

      function formatCurrency(val) {
        return 'R$ ' +
          val.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }

      function parseDate(dateStr) {
        return moment(dateStr, 'DD/MM/YYYY');
      }

      /** BADGES DE FILTROS **/
      function addFilterBadge(type, label) {
        const badge =
          `<span class="badge bg-secondary filter-badge" data-filter="${type}">
             ${type}: ${label}
             <i class="fas fa-times ms-1 remove-badge" style="cursor: pointer"></i>
           </span>`;
        $('#badgesContainer').append(badge);
        $('#btnClearFilters').show();
      }

      function clearAllBadges() {
        $('#badgesContainer').empty();
        $('#badgesContainer').text('Nenhum filtro aplicado');
        $('#btnClearFilters').hide();
      }

      function removeFilter(type) {
        filters[type] = null;
        $(`#badgesContainer .filter-badge[data-filter="${type}"]`).remove();

        if ($('#badgesContainer .filter-badge').length === 0) {
          clearAllBadges();
        }
        applyFiltersAndRender();
      }

      /** CONFIGURAÇÃO DO DATERANGEPICKER **/
      $('#dateRangeFilter').daterangepicker(
        {
          autoUpdateInput: false,
          opens: 'left',
          locale: { cancelLabel: 'Limpar', format: 'DD/MM/YYYY' }
        },
        function (start, end) {
          filters.dateFrom = start;
          filters.dateTo = end;
          $('#dateRangeFilter').val(
            start.format('DD/MM/YYYY') + ' – ' + end.format('DD/MM/YYYY')
          );
          $('#badgesContainer').find(`span[data-filter="dateRange"]`).remove();

          $(
            `<span class="badge bg-secondary filter-badge" data-filter="dateRange">
               Data: ${start.format('DD/MM/YYYY')} – ${end.format('DD/MM/YYYY')}
               <i class="fas fa-times ms-1 remove-badge" style="cursor: pointer"></i>
             </span>`
          ).appendTo('#badgesContainer');
          $('#btnClearFilters').show();
          applyFiltersAndRender();
        }
      );

      $('#dateRangeFilter').on('cancel.daterangepicker', function () {
        filters.dateFrom = null;
        filters.dateTo = null;
        $('#dateRangeFilter').val('');
        removeFilter('dateRange');
      });

      $('#badgesContainer').on('click', '.remove-badge', function () {
        const type = $(this).closest('.filter-badge').data('filter');
        if (type === 'dateRange') {
          filters.dateFrom = null;
          filters.dateTo = null;
          $('#dateRangeFilter').val('');
          clearAllBadges();
        } else {
          removeFilter(type);
        }
      });

      $('#btnClearFilters').on('click', function () {
        filters.dateFrom = null;
        filters.dateTo = null;
        filters.status = null;
        filters.categoria = null;
        filters.servico = null;
        $('#dateRangeFilter').val('');
        clearAllBadges();
        applyFiltersAndRender();
      });

      /** BUSCA DADOS DO SHEETDB **/
      function fetchData() {
        $.ajax({
          url: SHEETDB_URL,
          type: 'GET',
          success: function (response) {
            allRows = response.map((row) => {
              return {
                descricao: row['Descrição'] || '',
                valor: cleanCurrency(row['Valor Pagamento']),
                categoria: row['Categoria'] || '',
                fornecedor: row['Fornecedor'] || '',
                servico: row['Serviço'] || '',
                vencimento: row['Vencimento'] || '',
                dataPagamento: row['Data Pagamento'] || '',
                status: row['status do pagamento'] || '',
                mesVencimento: row['Mes de Vencimento'] || ''
              };
            });
            renderStats();
            renderCharts();
            renderTables();
          },
          error: function (xhr, status, error) {
            console.error('Erro ao buscar dados:', error);
            alert('Falha ao obter dados do SheetDB.');
          }
        });
      }

      /** RENDERIZAÇÃO DOS CARDS SUPERIORES **/
      function renderStats() {
        let sumPaid = 0, sumDue = 0, sumOverdue = 0;
        allRows.forEach((r) => {
          const dtNow = moment();
          const dtVenc = parseDate(r.vencimento);
          if (r.status.toLowerCase() === 'pago') {
            sumPaid += r.valor;
          } else {
            if (dtNow.isAfter(dtVenc, 'day')) {
              sumOverdue += r.valor;
            } else {
              sumDue += r.valor;
            }
          }
        });
        const sumTotal = sumPaid + sumDue + sumOverdue;
        $('#statPaid').text(formatCurrency(sumPaid));
        $('#statDue').text(formatCurrency(sumDue));
        $('#statOverdue').text(formatCurrency(sumOverdue));
        $('#statTotal').text(formatCurrency(sumTotal));
      }

      /** APLICA FILTROS E RETORNA LINHAS FILTRADAS **/
      function getFilteredRows() {
        return allRows.filter((r) => {
          if (filters.dateFrom && filters.dateTo) {
            const dtV = parseDate(r.vencimento);
            if (
              dtV.isBefore(filters.dateFrom, 'day') ||
              dtV.isAfter(filters.dateTo, 'day')
            ) {
              return false;
            }
          }
          if (filters.status && r.status !== filters.status) return false;
          if (filters.categoria && r.categoria !== filters.categoria)
            return false;
          if (filters.servico && r.servico !== filters.servico) return false;
          return true;
        });
      }

      /** RENDERIZA GRÁFICOS **/
      function renderCharts() {
        const data = getFilteredRows();

        // Gráfico de colunas mensal
        const monthlySums = {};
        data.forEach((r) => {
          if (!monthlySums[r.mesVencimento]) monthlySums[r.mesVencimento] = 0;
          monthlySums[r.mesVencimento] += r.valor;
        });
        const months = Object.keys(monthlySums).sort((a, b) => {
          const [mA, yA] = a.split('/');
          const [mB, yB] = b.split('/');
          return yA !== yB ? Number(yA) - Number(yB) : Number(mA) - Number(mB);
        });
        const values = months.map((m) => monthlySums[m]);
        const primaryBlue = getComputedStyle(document.documentElement)
          .getPropertyValue('--primary-blue')
          .trim();
        const colTrace = {
          x: months,
          y: values,
          type: 'bar',
          text: values.map((v) => formatCurrency(v)),
          textposition: 'auto',
          marker: { color: primaryBlue }
        };
        const colLayout = {
          margin: { t: 10, b: 40, l: 60, r: 20 },
          xaxis: { title: 'Mês' },
          yaxis: { title: 'Valor (R$)' },
          template: 'plotly_white'
        };
        Plotly.newPlot('chartMonthly', [colTrace], colLayout, {
          responsive: true
        });

        // Gráfico de pizza (status)
        let sumPaid = 0, sumDue = 0, sumOverdue = 0;
        data.forEach((r) => {
          const dtNow = moment();
          const dtVenc = parseDate(r.vencimento);
          if (r.status.toLowerCase() === 'pago') sumPaid += r.valor;
          else {
            if (dtNow.isAfter(dtVenc, 'day')) sumOverdue += r.valor;
            else sumDue += r.valor;
          }
        });
        const successGreen = getComputedStyle(document.documentElement)
          .getPropertyValue('--success-green')
          .trim();
        const warningYellow = getComputedStyle(document.documentElement)
          .getPropertyValue('--warning-yellow')
          .trim();
        const dangerRed = getComputedStyle(document.documentElement)
          .getPropertyValue('--danger-red')
          .trim();
        const pieTrace = {
          values: [sumPaid, sumDue, sumOverdue],
          labels: ['Pago', 'A Vencer', 'Vencido'],
          type: 'pie',
          hole: 0.4,
          textinfo: 'label+percent',
          insidetextorientation: 'radial',
          marker: { colors: [successGreen, warningYellow, dangerRed] }
        };
        const pieLayout = {
          margin: { t: 10, b: 10, l: 10, r: 10 },
          showlegend: false,
          template: 'plotly_white'
        };
        Plotly.newPlot('chartStatus', [pieTrace], pieLayout, {
          responsive: true
        });

        // Interatividade: clique na barra => filtra por mês
        document
          .getElementById('chartMonthly')
          .on('plotly_click', function (dataEvent) {
            const clickedMonth = dataEvent.points[0].x;
            filters.dateFrom = parseDate('01/' + clickedMonth);
            filters.dateTo = parseDate('01/' + clickedMonth).endOf('month');
            $('#badgesContainer').empty();
            $(
              `<span class="badge bg-secondary filter-badge" data-filter="dateRange">
                 Data: ${filters.dateFrom.format('DD/MM/YYYY')} – ${filters
                .dateTo.format('DD/MM/YYYY')}
                 <i class="fas fa-times ms-1 remove-badge" style="cursor: pointer"></i>
               </span>`
            ).appendTo('#badgesContainer');
            $('#btnClearFilters').show();
            applyFiltersAndRender();
          });

        // Clique na fatia da pizza => filtra por status
        document
          .getElementById('chartStatus')
          .on('plotly_click', function (dataEvent) {
            const clickedLabel = dataEvent.points[0].label;
            filters.status = clickedLabel;
            $('#badgesContainer')
              .find(`span[data-filter="status"]`)
              .remove();
            addFilterBadge('status', clickedLabel);
            applyFiltersAndRender();
          });
      }

      /** RENDERIZA AS TABELAS DE VENCIDOS/A VENCER/PAGOS **/
      function renderTables() {
        const data = getFilteredRows();
        const now = moment();
        const overdueRows = [];
        const dueRows = [];
        const paidRows = [];
        data.forEach((r) => {
          const dtV = parseDate(r.vencimento);
          if (r.status.toLowerCase() === 'pago') {
            paidRows.push(r);
          } else {
            if (now.isAfter(dtV, 'day')) overdueRows.push(r);
            else dueRows.push(r);
          }
        });

        function buildRows(arr, tipo) {
          if (arr.length === 0) {
            return `<tr><td colspan="3" class="text-center">Nenhum pagamento encontrado</td></tr>`;
          }
          return arr
            .map((r) => {
              const dateText =
                tipo === 'Pago'
                  ? r.dataPagamento || '-'
                  : r.vencimento || '-';
              const highlight =
                tipo !== 'Pago' && now.isAfter(parseDate(r.vencimento), 'day')
                  ? 'highlighted'
                  : '';
              return `<tr class="${highlight}">
                <td>${r.descricao}</td>
                <td>${dateText}</td>
                <td>${formatCurrency(r.valor)}</td>
              </tr>`;
            })
            .join('');
        }

        $('#tableOverdue').html(buildRows(overdueRows, 'Vencido'));
        $('#tableDue').html(buildRows(dueRows, 'A Vencer'));
        $('#tablePaid').html(buildRows(paidRows, 'Pago'));
      }

      /** APLICA FILTROS (sem chamar gráficos) **/
      function applyFiltersAndRender() {
        renderStats();
        renderCharts();
        renderTables();
      }

      // Ao carregar a página, busca dados
      fetchData();
    });
  </script>
</body>
</html>
